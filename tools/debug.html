<html>
<head>
<title>GoBattleSim Debug</title>

<style> 
	fieldset {width: 800px;}
	
	legend { font-size: 20px;}
	
	label.field {
					font-size: 15px;
					text-align: left; 
					width: 100px; 
					float: left;
					height: 10px;
				}
	
	input[type=number] {
		text-align: left; 
		width: 50px;
		height: 20px;
	}
	
	input[type=text] {
		text-align: left; 
		width: 120px;
		height: 20px;
	}

</style>

</head>
 
<body>

<h1> GoBattleSim Debug V0.4.1 </h1>
<h3>Developer Test Version</h3>

<script type="text/javascript" src="GoBattleSim.js"></script>

<button onclick="javascript:addTeamForAttacker()">Add Team</button>
<button onclick="javascript:addPokemonForAttacker()">Add Pokemon</button>
<button onclick="javascript:removePokemonForAttacker()">Remove Pokemon</button>




<form action="javascript:main()" name="Main">

<legend>Attacker Information</legend>
<table id="atkrsInfo">
	<tr>
		<th>Team#</th> <th>Copies</th>
		<th>Species</th> <th>Level</th> 
		<th>AtkIV</th> <th>DefIV</th> <th>StmIV</th> 
		<th>Fast Move</th> <th>Charged Move</th>
		<th>dodgeCMoves</th>
	</tr>

</table>



<br><br>


<legend>Enemy Information</legend>
<table id="dfdrsInfo">
	<tr>
		<th>Species</th> <th>Level</th> <th>AtkIV</th> <th>DefIV</th> <th>StmIV</th> 
		<th>Fast Move</th> <th>Charged Move</th> <th>Tier (-1 for gym defender)</th>
	</tr>
	<tr>
		<td><input type="text" name="defender_species" value="Blissey"></td> 
		<td><input type="number" name="defender_level" value="40"></td>
		<td><input type="number" name="defender_AtkIV" value="15"></td>
		<td><input type="number" name="defender_DefIV" value="15"></td>
		<td><input type="number" name="defender_StmIV" value="15"></td>
		<td><input type="text" name="defender_fmove" value="Zen Headbutt"></td>
		<td><input type="text" name="defender_cmove" value="Dazzling Gleam"></td>
		<td><input type="number" name="defender_raid_tier"  value="-1"></td>
	</tr>

</table>

<br><br>


	<legend>General Settings</legend>
	<p><label class="field">Weather: </label> <input type="text" name="weather" value="EXTREME"></p>
	<p><label class="field">Randomness: </label> <input type="checkbox" name="randonness"></p>
	<p><label class="field">Battle Log</label> <input type="checkbox" name="log_on"></p>




  <input type="submit" value="GoBattleSim!">
</form>


  
<fieldset>
 <legend>System Feedback</legend>
<p id="feedback"></p>
</fieldset>
 
<br>
<legend>Team Statistics</legend>
<table id="teamSummary">
	<tr>	<th>Team#</th>  <th>TDO</th>  <th>TDO%</th> <th>Duration</th> <th>DPS</th>
	</tr>
</table>



<br><br>
<legend>Pokemon Statistics</legend>
<table id="pokemonSummary">
	<tr>	<th>Team#</th>  <th>Pokemon</th>  <th>HP</th> <th>Energy</th> <th>TDO</th>  <th>Duration</th> <th>DPS</th> <th>TDO_Fast</th> <th>TEW</th>
	</tr>
</table>
 
 
 
 
 <br><br>
 <legend>Battle Log</legend>
 <table id="battleLog">

 </table>
 
 
 <script type="text/javascript">
function addTeamForAttacker() {
	addRowForAttacker(true);
}

function addPokemonForAttacker() {
	var rows = document.getElementById("atkrsInfo").rows;
	if (rows.length > 1)
		addRowForAttacker(false, rows[rows.length - 1]);
	else
		addRowForAttacker(true);
}

function addRowForAttacker(newTeam, lastRow){
	var table = document.getElementById("atkrsInfo");
	
	var position = table.rows.length;
    var row = table.insertRow(position);
	
	var teamName = "?";
	if (newTeam){
		if (position == 1)
			teamName = 1;
		else
			teamName = parseInt(table.rows[position - 1].cells[0].innerHTML) + 1;
	} else
		teamName = table.rows[position - 1].cells[0].innerHTML;
		
	row.insertCell(0).innerHTML = teamName;
	row.insertCell(1).innerHTML = '<input type="number" value="1">';
	row.insertCell(2).innerHTML = '<input type="text" value="Machamp">';
	row.insertCell(3).innerHTML = '<input type="number" value="40">';
	row.insertCell(4).innerHTML = '<input type="number" value="15">';
	row.insertCell(5).innerHTML = '<input type="number" value="15">';
	row.insertCell(6).innerHTML = '<input type="number" value="15">';
	row.insertCell(7).innerHTML = '<input type="text" value="Counter">';
	row.insertCell(8).innerHTML = '<input type="text" value="Dynamic Punch">';
	row.insertCell(9).innerHTML = '<input type="checkbox">';
	
	if (lastRow){
		row.cells[2].children[0].value = lastRow.cells[2].children[0].value;
		row.cells[3].children[0].valueAsNumber = lastRow.cells[3].children[0].valueAsNumber;
		row.cells[4].children[0].valueAsNumber = lastRow.cells[4].children[0].valueAsNumber;
		row.cells[5].children[0].valueAsNumber = lastRow.cells[5].children[0].valueAsNumber;
		row.cells[6].children[0].valueAsNumber = lastRow.cells[6].children[0].valueAsNumber;
		row.cells[7].children[0].value = lastRow.cells[7].children[0].value;
		row.cells[8].children[0].value = lastRow.cells[8].children[0].value;
	}
	
}

function removePokemonForAttacker(){
	var table = document.getElementById("atkrsInfo");
	if (table.rows.length > 1)
		table.deleteRow(table.rows.length - 1);
}
 

function main(){ 
	var mainForm = document.forms[0];
	
	clearTable("battleLog", 0);
	var newRow = document.getElementById("battleLog").insertRow(0);
	newRow.insertCell(0).innerHTML = "Time";
	newRow.insertCell(1).innerHTML = "(Defender)";
	
	document.getElementById("feedback").innerHTML = "";
	clearTable("teamSummary", 1);
	clearTable("pokemonSummary", 1);
	
	// Hellow, world
	var app_world = new World();
	
	// 1. Loading attackers
	var table = document.getElementById("atkrsInfo");
	var lastTeamNum = table.rows[1].cells[0].innerHTML;
	var curTeamNum = lastTeamNum;
	var curTeam = new Party([],0);
	for (var r = 1; r < table.rows.length; r++){
		var row = table.rows[r];
		curTeamNum = row.cells[0].innerHTML;
		if (curTeamNum != lastTeamNum){
			app_world.atkr_parties.push(curTeam);
			curTeam = new Party([], app_world.atkr_parties.length);
			lastTeamNum = curTeamNum;
		}
		var num_copies = row.cells[1].children[0].valueAsNumber;
		for(var i = 0; i < num_copies; i++){
			var pkm = new Pokemon(row.cells[2].children[0].value,
								[row.cells[4].children[0].valueAsNumber,
								row.cells[5].children[0].valueAsNumber,
								row.cells[6].children[0].valueAsNumber],
								row.cells[3].children[0].valueAsNumber,
								row.cells[7].children[0].value,
								row.cells[8].children[0].value,
								0);
			pkm.dodgeCMoves = row.cells[9].children[0].checked;
			curTeam.add(pkm);
		}
	}
	app_world.atkr_parties.push(curTeam);
	
	for (var i = 0; i < app_world.atkr_parties.length; i++){
		document.getElementById("battleLog").rows[0].insertCell(i + 1).innerHTML = i + 1;
	}
	
	// 2. Loading defender
	table = document.getElementById("dfdrsInfo");
	var row = table.rows[1];
	var app_dfdr = new Pokemon(row.cells[0].children[0].value, 
								[row.cells[2].children[0].valueAsNumber, 
								row.cells[3].children[0].valueAsNumber, 
								row.cells[4].children[0].valueAsNumber], 
								row.cells[1].children[0].valueAsNumber, 
								row.cells[5].children[0].value, 
								row.cells[6].children[0].value, 
								row.cells[7].children[0].valueAsNumber);
	app_world.dfdr_party = new Party([], -1);
	app_world.dfdr_party.add(app_dfdr);
	
	// 3. Set other parameters
	app_world.weather = mainForm['weather'].value.toUpperCase();
	app_world.randomness = mainForm['randonness'].checked;
	app_world.print_log_on = mainForm['log_on'].checked;

	// 4. Get it running! //
	app_world.battle();
	
	
	// 5. Get summary statistics
	fb_print("Simulation done. Check console for detailed Pokemon status");
	
	var teamTDOs_sum = 0;
	var teamDurations = [];
	var teamTDOs = [];
	for (var i = 0; i < app_world.atkr_parties.length; i++){
		teamDurations.push(0);
		teamTDOs.push(0);
		var ap = app_world.atkr_parties[i];
		for(var j = 0; j < ap.list.length; j++){
			var pkm = ap.list[j];
			var dur = Math.round((pkm.time_leave_ms - pkm.time_enter_ms)/100)/10;				
			teamDurations[i] += dur;
			teamTDOs[i] += pkm.total_damage_output;
			
			// Team#, Pokemon, HP, Energy, TDO, Duration, DPS, TDO_Fast, TEW
			newRowForTable("pokemonSummary", [i+1, pkm.name, pkm.HP, pkm.energy, pkm.total_damage_output,
							dur, Math.round(pkm.total_damage_output/dur*100)/100,
							pkm.total_fmove_damage_output, pkm.energy + pkm.total_energy_overcharged]);
		}
		teamTDOs_sum += teamTDOs[i];
	}
	
	for (var i = 0; i < app_world.atkr_parties.length; i++){
		//Team#, TDO, TDO%, Duration, DPS
		newRowForTable("teamSummary", [i+1, teamTDOs[i], (Math.round(teamTDOs[i]/teamTDOs_sum*10000)/100).toString() + "%",
						Math.round(teamDurations[i]*10)/10, Math.round(teamTDOs[i]/teamDurations[i]*100)/100]);
	}
	
	var pkm = app_dfdr;
	var dur = Math.round((app_dfdr.time_leave_ms - app_dfdr.time_enter_ms)/100)/10;
	newRowForTable("pokemonSummary", ["Enemy", pkm.name, pkm.HP, pkm.energy, pkm.total_damage_output,
							dur, Math.round(pkm.total_damage_output/dur*100)/100,
							pkm.total_fmove_damage_output, pkm.energy + pkm.total_energy_overcharged]);
	
	console.log(app_world);
}
 
 
function fb_print(msg){
	document.getElementById("feedback").innerHTML += msg + "<br />";
}




function checkAndPush(rowData){
	for (var i = 1; i < rowData.length; i++){
		if (rowData[i] != ""){
			newRowForTable("battleLog", rowData);
			return;
		}
	}
}



function addBattleLog(events){
	// events of the same time
	var table = document.getElementById("battleLog");
	var numTeam = table.rows[0].cells.length - 2;
	var Enter_rowData = [Math.round((events[0]).t/10)/100];
	var AtkrHurt_rowData = [Math.round((events[0]).t/10)/100];
	var DfdrHurt_rowData = [Math.round((events[0]).t/10)/100];
	var AtkrDogde_rowData = [Math.round((events[0]).t/10)/100];
	
	// Time, Team 1, Team 2, ..., Defender
	for (var i = 1; i < numTeam + 2; i++){
		Enter_rowData.push(" ");
		AtkrHurt_rowData.push(" ");
		DfdrHurt_rowData.push(" ");
		AtkrDogde_rowData.push(" ");
	}
	
	var e = 0;
	for (var i = 0; i < events.length; i++){
		e = events[i];
		if (e.name == "Enter"){
			if (e.subject.party_index == -1)
				Enter_rowData[numTeam + 1] = e.subject.name;
			else
				Enter_rowData[e.subject.party_index + 1] = e.subject.name;
		}else if (e.name == "Hurt"){
			if (e.subject.raidTier == 0){ // atkrHurt
				AtkrHurt_rowData[e.subject.party_index + 1] = e.subject.HP + '/' + e.subject.maxHP;
				AtkrHurt_rowData[numTeam + 1] = e.move.name;
			} else{ // dfdrHurt
				DfdrHurt_rowData[numTeam + 1] = e.subject.HP + '/' + e.subject.maxHP;
				DfdrHurt_rowData[e.object.party_index + 1] = e.move.name;
			}
		}else if (e.name == "Dodge"){
			AtkrDogde_rowData[e.subject.party_index + 1] = "dodge";
		}
	}
	
	checkAndPush(Enter_rowData);
	checkAndPush(AtkrHurt_rowData);
	checkAndPush(DfdrHurt_rowData);
	checkAndPush(AtkrDogde_rowData);
}





function clearTable(TableID, numRowsToKeep){
	var table = document.getElementById(TableID);
	while(table.rows.length > numRowsToKeep){
		table.deleteRow(table.rows.length - 1);
	}
}

function newRowForTable(TableID, rowData){
	var table = document.getElementById(TableID);
	var newRow = table.insertRow(table.length);
	for (var i = 0; i < rowData.length; i++){
		newRow.insertCell(i).innerHTML = rowData[i];
	}
}
 
 
 
 </script>

 
 
 

</body>
</html>