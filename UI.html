<style>
	table{
		width: 100%;
	}
	
	th, td {
		vertical-align: center;
		text-align: center;
	}
	
	input, select {
		width: 100%;
	}
	
	button {
		width: 100%;
	}
}
</style>

<datalist id="SpeciesNameDataList"></datalist>
<datalist id="FMovesDataList"></datalist>
<datalist id="CMovesDataList"></datalist>

<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/angularjs/1.6.7/angular.min.js"></script>
<script type="text/javascript" src="GoBattleSim.js"></script>
<script type="text/javascript">

function initDataList(){
	var speciesOptions = "";
	for (var i = 0; i < POKEMON_SPECIES_DATA.length; i++)
		speciesOptions += '<option value="'+ POKEMON_SPECIES_DATA[i].name +'" />';
	document.getElementById("SpeciesNameDataList").innerHTML = speciesOptions;
	
	var fmoveOptions = "";
	for (var i = 0; i < FAST_MOVE_DATA.length; i++)
		fmoveOptions += '<option value="'+ FAST_MOVE_DATA[i].name +'" />';
	document.getElementById("FMovesDataList").innerHTML = fmoveOptions;
	
	var cmoveOptions = "";
	for (var i = 0; i < CHARGED_MOVE_DATA.length; i++)
		cmoveOptions += '<option value="'+ CHARGED_MOVE_DATA[i].name +'" />';
	document.getElementById("CMovesDataList").innerHTML = cmoveOptions;
}

function createElement(type, innerHTML){
	var e = document.createElement(type);
	e.innerHTML = innerHTML;
	return e;
}

function createPokemonTemplate(){
	var pkm = document.createElement("div");

	var row1 = document.createElement("tr");
	var row2 = document.createElement("tr");
	var row3 = document.createElement("tr");
	
	var tb1 = createElement("table", "<col width=50%><col width=35%><col width=5%><col width=5%><col width=5%>");
	row1.appendChild(createElement('td',"<input type='text' placeholder='Species' list='SpeciesNameDataList'>"));
	row1.appendChild(createElement('td',"<input type='number' placeholder='Copies' min='1' max='6'>"));
	row1.appendChild(createElement('td',"<button>X</button>"));
	row1.appendChild(createElement('td',"<button>&uarr;</button>"));
	row1.appendChild(createElement('td',"<button>&darr;</button>"));
	tb1.appendChild(row1);
	
	var tb2 = createElement("table", "<col width=25%><col width=25%><col width=25%><col width=25%>");
	row2.appendChild(createElement('td',"<input type='number' placeholder='Level' min='1' max='40'>"));
	row2.appendChild(createElement('td',"<input type='number' placeholder='HP. IV' min='0' max='15'>"));
	row2.appendChild(createElement('td',"<input type='number' placeholder='Atk. IV' min='0' max='15'>"));
	row2.appendChild(createElement('td',"<input type='number' placeholder='Def. IV' min='0' max='15'>"));
	tb2.appendChild(row2);

	var tb3 = createElement("table", "<col width=35%><col width=35%><col width=30%>");
	row3.appendChild(createElement('td',"<input type='text' placeholder='Fast Move' list='FMovesDataList'>"));
	row3.appendChild(createElement('td',"<input type='text' placeholder='Charged Move' list='CMovesDataList'>"));
	row3.appendChild(createElement('td',"<select><option value='0'>No Dodge</option><option value='1'>Dodge Charged</option><option value='2'>Dodge All</option></select></td>"));
	tb3.appendChild(row3);
	
	pkm.appendChild(tb1);
	pkm.appendChild(tb2);
	pkm.appendChild(tb3);
	return pkm;
}

function createTeamButtonTable(i){
	const iii = i;
	var tb = createElement("table","<col width=50%><col width=50%>");
	var row = createElement("tr","<td></td><td></td>");
	var b1 = createElement("button", "Add Pokemon");
	var b2 = createElement("button", "Remove Team");
	b1.addEventListener("click", function(){addPokemon(iii);});
	b2.addEventListener("click", function(){removeTeam(iii);});
	row.children[0].appendChild(b1);
	row.children[1].appendChild(b2);
	tb.appendChild(row);
	return tb;
}

// Re positioning all Pokemon from Team (start+1) up to but excluding Team (end+1)
function repositionAllPokemon(start, end){
	var teams = document.getElementById("AttackerInput");
	start = start || 0;
	end = end || teams.children.length;
	for (var i = start; i < end; i++){
		const iii = i;
		var team = teams.children[i];
		team.children[0].innerHTML = "Team " + (i+1);
		for (var j = 1; j < team.children.length - 1; j++){
			const jjj = j;
			var symsbolsAndFunctions = [["&uarr;", function(){movePokemonUp(iii, jjj);}],
										["&darr;", function(){movePokemonDown(iii, jjj);}],
										["X", function(){removePokemon(iii, jjj);}]];
			for (var k = 0; k < symsbolsAndFunctions.length; k++){
				var td = team.children[j].children[0].children[1].children[k+2];
				var b = createElement("button", symsbolsAndFunctions[k][0]);
				b.addEventListener("click", symsbolsAndFunctions[k][1]);
				td.removeChild(td.children[0]);
				td.appendChild(b);
			}
		}
		team.removeChild(team.children[team.children.length - 1]);
		team.appendChild(createTeamButtonTable(i));
	}
}


function addPokemon(i){
	var team = document.getElementById("AttackerInput").children[i];
	team.removeChild(team.children[team.children.length - 1]);
	team.appendChild(createPokemonTemplate());
	team.appendChild(createElement("div",""));
	repositionAllPokemon(i, i+1);
}

function removePokemon(i, j){
	var team = document.getElementById("AttackerInput").children[i];
	if (team.children.length > 3){
		team.removeChild(team.children[j]);
		repositionAllPokemon(i, i+1);
	}else
		send_feedback("Can't remove the only attacker in the team. Use Remove Team instead");
}

function swapChildren(parent, i1, i2){
	var children = [];
	while (parent.children.length > 0){
		children.push(parent.children[0]);
		parent.removeChild(parent.children[0]);
	}
	var intermediate = children[i1];
	children[i1] = children[i2];
	children[i2] = intermediate;
	for (var k = 0; k < children.length; k++)
		parent.appendChild(children[k]);
}

function movePokemonUp(i, j){
	var team = document.getElementById("AttackerInput").children[i];
	if (j > 1){
		swapChildren(team, j, j - 1);
		repositionAllPokemon(i, i + 1);
	}
}

function movePokemonDown(i, j){
	var team = document.getElementById("AttackerInput").children[i];
	if (j < team.children.length - 2){
		swapChildren(team, j, j + 1);
		repositionAllPokemon(i, i + 1);
	}
}

function addTeam(){
	if (totalAtkrTeamCount < MAX_NUMBER_OF_TEAMS){
		var teams = document.getElementById("AttackerInput");
		var newTeam = document.createElement("div");
		newTeam.appendChild(createElement("h3","Team" + (totalAtkrTeamCount+1)));
		newTeam.appendChild(createPokemonTemplate());
		newTeam.appendChild(createElement("div",""));
		teams.appendChild(newTeam);
		totalAtkrTeamCount++;
		repositionAllPokemon(totalAtkrTeamCount - 1);
	}else{
		send_feedback("exceeding maximum parties allowed");
	}
}

function removeTeam(i){
	if (totalAtkrTeamCount >= 2){
		var teams = document.getElementById("AttackerInput");
		teams.removeChild(teams.children[i]);
		totalAtkrTeamCount--;
		repositionAllPokemon(i);
	}
	else
		send_feedback("Can't remove the only team");
}

function setDefenderInput(){
	var mode = document.getElementById("battleMode").value;
	var dfdrSection = document.getElementById("DefenderInput");
	var tb1 = createElement("table", "<col width=100%>");
	var tb2 = createElement("table", "");
	var tb3 = createElement("table", "<col width=50%><col width=50%>");
	var row1 = createElement("tr","");
	var row2 = createElement("tr","");
	var row3 = createElement("tr","");
	
	if (dfdrSection.children.length > 0){
		tb1 = dfdrSection.children[0];
		tb3 = dfdrSection.children[2];
	}else{
		row1.appendChild(createElement('td',"<input type='text' placeholder='Species' list='SpeciesNameDataList'>"));
		tb1.appendChild(row1);
		row3.appendChild(createElement('td',"<input type='text' placeholder='Fast Move' list='FMovesDataList'>"));
		row3.appendChild(createElement('td',"<input type='text' placeholder='Charged Move' list='CMovesDataList'>"));
		tb3.appendChild(row3);
	}

	if (mode=="gym"){
		tb2.innerHTML = "<col width=25%><col width=25%><col width=25%><col width=25%>";
		row2.appendChild(createElement("td","<input type='number' placeholder='Level'>"));
		row2.appendChild(createElement("td","<input type='number' placeholder='HP. IV'>"));
		row2.appendChild(createElement("td","<input type='number' placeholder='Atk. IV'>"));
		row2.appendChild(createElement("td","<input type='number' placeholder='Def. IV'>"));
	}else if (mode == "raid"){
		tb2.innerHTML = "<col width=100%>";
		row2.appendChild(createElement("td","Raid Tier:"));
		var raidSelection = document.createElement("select");
		raidSelection.id = "raidTier";
		for (var i = 1; i <= 5; i++){
			var option = createElement("option", i);
			option.value = i;
			raidSelection.appendChild(option);
		}
		row2.children[0].appendChild(raidSelection);
	}
	tb2.appendChild(row2);
	
	dfdrSection.innerHTML = "";
	dfdrSection.appendChild(tb1);
	dfdrSection.appendChild(tb2);
	dfdrSection.appendChild(tb3);
}

function parseAttackerInput(section){
	var row1 = section.children[0].children[1];
	var row2 = section.children[1].children[1];
	var row3 = section.children[2].children[1];
	var pkm = {
		species_name: row1.children[0].children[0].value.trim(),
		copies: row1.children[1].children[0].valueAsNumber || 1,
		level: Math.max(1, Math.min(40,row2.children[0].children[0].valueAsNumber)),
		stmiv: Math.max(0, Math.min(15,row2.children[1].children[0].valueAsNumber)),
		atkiv: Math.max(0, Math.min(15,row2.children[2].children[0].valueAsNumber)),
		defiv: Math.max(0, Math.min(15,row2.children[3].children[0].valueAsNumber)),
		fmove: row3.children[0].children[0].value.trim(),
		cmove: row3.children[1].children[0].value.trim(),
		dodge: row3.children[2].children[0].value,
		raid_tier : 0
	};
	return pkm;
}

function parseDefenderInput(section){
	var row1 = section.children[0].children[1];
	var row2 = section.children[1].children[1];
	var row3 = section.children[2].children[1];
	var pkm = {
		team_idx : -1,
		species_name: row1.children[0].children[0].value.trim(),
		level : 1,
		atkiv : 0,
		defiv : 0,
		stmiv : 0,
		fmove: row3.children[0].children[0].value.trim(),
		cmove: row3.children[1].children[0].value.trim()
	};
	if (document.getElementById("battleMode").value == "gym"){
		pkm['level'] = Math.max(1, Math.min(40,row2.children[0].children[0].valueAsNumber));
		pkm['stmiv'] = Math.max(0, Math.min(15,row2.children[1].children[0].valueAsNumber));
		pkm['atkiv'] = Math.max(0, Math.min(15,row2.children[2].children[0].valueAsNumber));
		pkm['defiv'] = Math.max(0, Math.min(15,row2.children[3].children[0].valueAsNumber));
		pkm['raid_tier'] = -1;
	}else if (document.getElementById("battleMode").value == "raid"){
		pkm['raid_tier'] = parseInt(document.getElementById("raidTier").value);
	}
	return pkm;
}

function writeAttackerInput(section, pkm){
	var row1 = section.children[0].children[1];
	var row2 = section.children[1].children[1];
	var row3 = section.children[2].children[1];
	
	row1.children[0].children[0].value = pkm.species_name;
	row1.children[1].children[0].value = pkm.copies;
	row2.children[0].children[0].value = pkm.level;
	row2.children[1].children[0].value = pkm.stmiv;
	row2.children[2].children[0].value = pkm.atkiv;
	row2.children[3].children[0].value = pkm.defiv;
	row3.children[0].children[0].value = pkm.fmove;
	row3.children[1].children[0].value = pkm.cmove;
	row3.children[2].children[0].value = pkm.dodge;
}

function writeDefenderInput(section, pkm){
	var row1 = section.children[0].children[1];
	var row2 = section.children[1].children[1];
	var row3 = section.children[2].children[1];
	
	row1.children[0].children[0].value = pkm['species_name'];
	row3.children[0].children[0].value = pkm['fmove'];
	row3.children[1].children[0].value = pkm['cmove'];
	if (document.getElementById("battleMode").value == "gym"){
		row2.children[0].children[0].value = pkm['level'];
		row2.children[1].children[0].value = pkm['stmiv'];
		row2.children[2].children[0].value = pkm['atkiv'];
		row2.children[3].children[0].value = pkm['defiv'];
	}else if (document.getElementById("battleMode").value ==  "raid"){
		document.getElementById("raidTier").value = pkm['raid_tier'];
	}
}

function readUserInput(){
	var gSettings = {};
	if (document.getElementById("battleMode").value == "raid")
		gSettings['raidTier'] = (parseInt(document.getElementById("raidTier").value));
	else if (document.getElementById("battleMode").value == "gym")
		gSettings['raidTier'] = -1;
	gSettings['weather'] = document.getElementById("weather").value;
	gSettings['dodgeBug'] = parseInt(document.getElementById("dodgeBug").value);
	gSettings['simType'] = document.getElementById("simType").value;
	if (gSettings['simType'] != '1')
		gSettings['logStyle'] = 0;
	else if (totalAtkrTeamCount == 1 || totalAtkrTeamCount > 3)
		gSettings['logStyle'] = 1;
	else
		gSettings['logStyle'] = 2;
	
	var atkr_parties = [];
	var attackerSections = document.getElementById("AttackerInput").children;
	for (var i = 0; i < attackerSections.length; i++){
		atkr_parties.push([]);
		var sec = attackerSections[i];
		for (var j = 1; j < sec.children.length - 1; j++)
			atkr_parties[i].push(parseAttackerInput(sec.children[j]));
	}
	
	var defenderSection = document.getElementById("DefenderInput");
	var dfdr_info = parseDefenderInput(defenderSection);
	return {generalSettings : gSettings,
			atkrSettings : atkr_parties,
			dfdrSettings : dfdr_info
			};
}

function writeUserInput(cfg){
	if (cfg['generalSettings']['raidTier'] == -1){
		document.getElementById("battleMode").value = "gym";
	}
	else{
		document.getElementById("battleMode").value = "raid";
	}
	document.getElementById("weather").value = cfg['generalSettings']['weather'];
	document.getElementById("dodgeBug").value = cfg['generalSettings']['dodgeBug'];
	document.getElementById("simType").value = cfg['generalSettings']['simType'];
	
	var attackerSections = document.getElementById("AttackerInput");
	while (attackerSections.children.length > 0)
		attackerSections.removeChild(attackerSections.children[attackerSections.children.length - 1]);
	totalAtkrTeamCount = 0;
	
	for (var i = 0; i < cfg['atkrSettings'].length; i++){
		addTeam();
		for (var j = 0; j < cfg['atkrSettings'][i].length; j++){
			if (j >= 1)
				addPokemon(i);
			writeAttackerInput(attackerSections.children[i].children[j+1], cfg['atkrSettings'][i][j]);
		}
	}
		
	setDefenderInput();
	var defenderSection = document.getElementById("DefenderInput");
	writeDefenderInput(defenderSection, cfg['dfdrSettings']);
}

function createRow(rowData, type){
	type = type || "td";
	var row = document.createElement("tr");
	for (var i = 0; i < rowData.length; i++){
		var d = document.createElement(type);
		d.style
		d.innerHTML = rowData[i];
		row.appendChild(d);
	}
	return row;
}

function createMasterSummaryTable(sims){
	var table = document.createElement("table");
	var headers = createRow(MasterSummaryTableMetricHeaders.concat(["Details"]),"th");
	
	for (var i = 0; i < headers.children.length - 1; i++){
		const ii = i;
		headers.children[i].onclick = function(){sortMasterSummaryTable(MasterSummaryTableMetrics[ii]);};
	}
	table.appendChild(headers);
	
	for (var i = 0; i < sims.length; i++){
		var gs = sims[i]['output']['generalStat']; // represents a single sim's general stats
		var row = [];
		for (var j = 0; j < MasterSummaryTableMetrics.length; j++)
			row.push(gs[MasterSummaryTableMetrics[j]]);
		row.push("<button onclick='displayDetail("+i+")'>Detail</button>");
		table.appendChild(createRow(row, "td"));
	}
	return table;
}

function sortMasterSummaryTable(attr){
	if (MasterSummaryTableMetricsSorted[attr] == 0)
		MasterSummaryTableMetricsSorted[attr] = 1;
	sortByDeepAttr(simResults, ['output', 'generalStat', attr], MasterSummaryTableMetricsSorted[attr]);
	MasterSummaryTableMetricsSorted[attr] *= -1;
	displayMasterSummaryTable();
}


function createTeamStatisticsTable(teamStats){
	var table = document.createElement("table");
	table.appendChild(createRow(["Team#","TDO","TDO%","#Rejoin","#Deaths"],"th"));
	for (var i = 0; i < teamStats.length; i++){
		var ts = teamStats[i];
		table.appendChild(createRow([ts.team, ts.tdo, ts.tdo_percentage, ts.num_rejoin, ts.total_deaths],"td"));
	}
	return table;
}

function createPokemonStatisticsTable(pokemonStats){
	var table = document.createElement("table");
	table.appendChild(createRow(["Team#",
								"<img src='https://pokemongo.gamepress.gg/assets/img/sprites/000MS.png'></img>",
								"HP",
								"Energy",
								"TDO",
								"Duration",
								"DPS",
								"TEO"],"th"));
	for (var i = 0; i < pokemonStats.length; i++){
		var ps = pokemonStats[i];
		table.appendChild(createRow([ps.team, ps.img, ps.hp, ps.energy, ps.tdo, ps.duration, ps.dps, ps.teo],"td"));
	}
	return table;
}

function createBattleLogTable(log, log_style){
	var table = document.createElement("table");
	if (log_style == 1){
		var headers = ["Time",
					"Team#",
					"<img src='https://pokemongo.gamepress.gg/assets/img/sprites/000MS.png'></img>",
					"Action",
					"Defender"];
		table.appendChild(createRow(headers, "th"));
		
		for (var i = 0; i < log.length; i++){
			table.appendChild(createRow(log[i]), "td");
		}
	}else if (log_style == 2){
		var headers = ["Time"];
		for (var i = 1; i <= totalAtkrTeamCount; i++)
			headers.push("Team"+i);
		headers.push("Defender");
		table.appendChild(createRow(headers, "th"));
		
		for (var i = 0; i < log.length; i++){
			table.appendChild(createRow(log[i]), "td");
		}
	}
	return table;
}

function main(){
	simQueue.push(readUserInput());
	while (simQueue.length > 0)
		processQueue(simQueue.pop());
	displayMasterSummaryTable();
	send_feedback("Simulation done.");
}

function enqueueSim(cfg){
	if (simQueue.length < MAX_QUEUE_SIZE){
		var cfg_copy = JSON.parse(JSON.stringify(cfg));
		simQueue.push(cfg_copy);
	}else
		send_feedback("Too many sims to unpack. Try to use less enumerators");
}


// Unpack enumerated sim, or run fully an unpacked one
function processQueue(cfg){
	for (var i = 0; i < cfg['atkrSettings'].length; i++){
		for (var j = 0; j < cfg['atkrSettings'][i].length; j++){
			var dex = get_species_index_by_name(cfg['atkrSettings'][i][j].species_name);
			if (cfg['atkrSettings'][i][j].fmove == '*'){
				var fmoves = POKEMON_SPECIES_DATA[dex].fastMoves;
				for (var k = 0; k < fmoves.length; k++){
					cfg['atkrSettings'][i][j].fmove = fmoves[k];
					enqueueSim(cfg);
				}
				return;
			}
			if (cfg['atkrSettings'][i][j].cmove == '*'){
				var cmoves = POKEMON_SPECIES_DATA[dex].chargedMoves;
				for (var k = 0; k < cmoves.length; k++){
					cfg['atkrSettings'][i][j].cmove = cmoves[k];
					enqueueSim(cfg);
				}
				return;
			}
		}
	}	
	var dex = get_species_index_by_name(cfg['dfdrSettings'].species_name);
	if (cfg['dfdrSettings'].fmove == '*'){
		var fmoves = POKEMON_SPECIES_DATA[dex].fastMoves;
		for (var k = 0; k < fmoves.length; k++){
			cfg['dfdrSettings'].fmove = fmoves[k];
			enqueueSim(cfg);
		}
		return;
	}
	if (cfg['dfdrSettings'].cmove == '*'){
		var cmoves = POKEMON_SPECIES_DATA[dex].chargedMoves;
		for (var k = 0; k < cmoves.length; k++){
			cfg['dfdrSettings'].cmove = cmoves[k];
			enqueueSim(cfg);
		}
		return;
	}
	runSim(cfg);
}

// Running a specific sim without any enumerator and push result(s) to simResults
function runSim(cfg){
	var numSimToRun = 1;
	if (cfg['generalSettings']['simType'] == '2'){
		numSimToRun = 100;
	} else if (cfg['generalSettings']['simType'] == '3'){
		numSimToRun = 1000;
	}
	var interResults = [];
	for (var i = 0; i < numSimToRun; i++){
		app_world = new World();
		app_world.config(cfg);
		app_world.battle();
		interResults.push(app_world.get_statistics());
	}
	simResults.push({
			input: cfg, 
			output: averageResults(interResults)
		});
}

// Averaging some key performance metrics
function averageResults(results){
	var avrgResult = JSON.parse(JSON.stringify(results[0]));
	var numResults = results.length;
	var sumWin = 0, sumDuration = 0, sumEnemyHPLostPctg = 0, sumDeaths = 0;
	for (var i = 0; i < numResults; i++){
		var gs = results[i]['generalStat'];
		if (gs['battle_result'] == 'Win')
			sumWin++;
		sumDuration += gs['duration'];
		sumEnemyHPLostPctg += gs['dfdr_HP_lost_percent'];
		sumDeaths += gs['total_deaths'];
	}
	if (numResults > 1){
		avrgResult['generalStat']['battle_result'] = Math.round(sumWin/numResults*1000)/10 + "%Win";
	}else{
		avrgResult['generalStat']['battle_result'] = results[0]['generalStat']['battle_result'];
	}
	avrgResult['generalStat']['duration'] = Math.round(sumDuration/numResults*10)/10;
	avrgResult['generalStat']['dfdr_HP_lost_percent'] = Math.round(sumEnemyHPLostPctg/numResults*100)/100;
	avrgResult['generalStat']['total_deaths'] = Math.round(sumDeaths/numResults*100)/100;
	
	return avrgResult;
}

function sortByDeepAttr(data, attrs, reversed){
	data.sort(function(a, b){
		for (var i = 0; i < attrs.length; i++){
			a = a[attrs[i]];
			b = b[attrs[i]];
		}
		return ((a == b) ? 0 : (a < b ? -1 : 1)) * reversed;
	});
}

function clearFeedbackTables(){
	document.getElementById("feedback_table1").innerHTML = "";
	document.getElementById("feedback_table2").innerHTML = "";
	document.getElementById("feedback_table3").innerHTML = "";
}

function displayMasterSummaryTable(){
	clearFeedbackTables();
	send_feedback("Display all sims run");
	if (configStack.length > 0)
		writeUserInput(configStack.pop());
	document.getElementById("feedback_table1").appendChild(createMasterSummaryTable(simResults));
	
	var buttonSection = document.getElementById("feedback_buttons");
	buttonSection.innerHTML = "";
	var tb = createElement("table","<col width=50%><col width=50%>");
	var tr = createElement("tr","");
	tr.appendChild(createElement("td","<button onclick='clearSimResults(false)'>Clear</button>"));
	tr.appendChild(createElement("td","<button onclick='clearSimResults(true)'>Clear All</button>"));
	tb.appendChild(tr);
	buttonSection.appendChild(tb);
}

function displayDetail(i){
	clearFeedbackTables();
	send_feedback("Display details of Simulation#"+(i+1));
	
	configStack.push(readUserInput(simResults[i]['input']));
	writeUserInput(simResults[i]['input']);
	
	var gs = simResults[i]['output'];
	document.getElementById("feedback_table1").appendChild(createTeamStatisticsTable(gs['teamStat']));
	document.getElementById("feedback_table2").appendChild(createPokemonStatisticsTable(gs['pokemonStat']));
	document.getElementById("feedback_table3").appendChild(createBattleLogTable(gs['battleLog'], app_world.log_style));
	document.getElementById("feedback_buttons").innerHTML = "<button onclick='displayMasterSummaryTable()'>Back</button>";
}

function send_feedback(msg){
	document.getElementById("feedback_message").innerHTML = msg;
}

function clearSimResults(clearAll){
	if (clearAll)
		simResults = [];
	else if (simResults.length > 0)
		simResults.pop();

	displayMasterSummaryTable();
	send_feedback("Simulation result cleared");
}


</script>

<h2>Attacker Information</h2>
<button onclick="javascript:addTeam()">Add Team</button>
<br>

<div id="AttackerInput">
</div>


<h2>Defender Information</h2>
<div id="DefenderInput">
</div>


<h2>General Settings</h2>
<div id="GeneralSettings">
	<table>
	<col width=25%><col width=25%><col width=25%><col width=25%>
	<tr>
		<th>Battle Mode</th><th>Weather</th><th>Dodge Bug</th><th>Simulation Type</th>
	</tr>
	<tr>
		<td><select id="battleMode"  onchange="setDefenderInput()">
				<option value="gym">Gym</option>
				<option value="raid">Raid</option>
			</select>
		</td>
		<td>
			<select id="weather">
				<option value="EXTREME">Extreme</option>
				<option value="SUNNY_CLEAR">Sunner/Clear</option>
				<option value="RAIN">Rain</option>
				<option value="PARTLY_CLOUDY">Party Cloudy</option>
				<option value="CLOUDY">Cloudy</option>
				<option value="WINDY">Windy</option>
				<option value="SNOW">Snow</option>
				<option value="FOG">Fog</option>
			</select>
		</td>
		<td>
			<select id="dodgeBug">
				<option value="0">Absent</option>
				<option value="1">Present</option>
			</select>
		</td>
		<td>
			<select id="simType">
				<option value="1">Single Random Battle</option>
				<option value="2">Average 100</option>
				<option value="3">Average 1000</option>
			</select>
		</td>
	</tr>
	</table>
</div>

<br>
<button onclick="main()" id="GoButton">Go</button>


<h2>Feedback</h2>
<div id="feedback_message"></div>
<div id="feedback_buttons"></div>
<div id="feedback_table1"></div>
<div id="feedback_table2"></div>
<div id="feedback_table3"></div>


<script type="text/javascript">

var MAX_QUEUE_SIZE = 1024;
var totalAtkrTeamCount = 0;
var MasterSummaryTableMetrics = ['battle_result','duration','dfdr_HP_lost_percent','total_deaths'];
var MasterSummaryTableMetricHeaders = ['Outcome','Time','EnemyHPLost%','#Death'];
var simQueue = []; // Batch individual sims configurations here
var simResults = []; // This is used to store many sims result
var configStack = []; // Store temporary user configurations

var MasterSummaryTableMetricsSorted = {};
for (var i = 0; i < MasterSummaryTableMetrics.length; i++)
	MasterSummaryTableMetricsSorted[MasterSummaryTableMetrics[i]] = 0;

initDataList();
addTeam();
setDefenderInput();

// Debug
var dbgs = {
	generalSettings : {battleMode: "raid", weather : "CLOUDY", dodgeBug: 0, simType : 1},
	atkrSettings : [[{	
						copies: 6,
						species_name: "machamp", 
						level: 40,
						atkiv: 15,
						defiv: 15,
						stmiv: 15,
						fmove: "counter",
						cmove: "dynamic punch",
						dodge: 1
					}]],
	dfdrSettings : {	
						species_name: "blissey", 
						fmove: "pound",
						cmove: "dazzling gleam",
						raid_tier: 3
					}
};

writeUserInput(dbgs);

</script>
